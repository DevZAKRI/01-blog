<h2 mat-dialog-title>Edit Post</h2>
<mat-dialog-content>
  <form [formGroup]="postForm" class="post-form">
    <!-- Title Field -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Post Title</mat-label>
      <input matInput
             formControlName="title"
             placeholder="Enter post title..."
             maxlength="200">
      <mat-hint>{{ postForm.get('title')?.value?.length || 0 }} / 200</mat-hint>
      <mat-error *ngIf="postForm.get('title')?.hasError('required')">
        Title is required
      </mat-error>
      <mat-error *ngIf="postForm.get('title')?.hasError('maxlength')">
        Title cannot exceed 200 characters
      </mat-error>
    </mat-form-field>

    <!-- Quill Editor for Description -->
    <div class="editor-label">
      <label>Post Description</label>
    </div>
    <textarea
      formControlName="description"
      placeholder="Write your post description here..."
      rows="4"
      class="description-textarea"></textarea>
    <div class="description-hint">{{ postForm.get('description')?.value?.length || 0 }} / 5000</div>
    <mat-error *ngIf="postForm.get('description')?.hasError('required')" class="error-text">
      Description is required
    </mat-error>
    <mat-error *ngIf="postForm.get('description')?.hasError('maxlength')" class="error-text">
      Description cannot exceed 5000 characters
    </mat-error>

    <!-- Media Upload Section -->
    <div class="media-upload-section">
      <label for="media-input" class="media-label" [class.disabled]="!canAddMore()">
        <mat-icon>add_photo_alternate</mat-icon>
        <span>Add More Media (Max 4)</span>
      </label>
      <input #fileInput
             type="file"
             id="media-input"
             accept="image/*,video/*"
             multiple
             [disabled]="!canAddMore()"
             (change)="onMediaFileSelected($event)"
             hidden>
      <small class="media-hint">{{ getTotalMediaCount() }} / 4 media files</small>
    </div>

    <!-- Uploaded Media Preview (Existing) -->
    <div class="media-gallery" *ngIf="uploadedMediaUrls.length > 0">
      <h4>Current Media</h4>
      <div class="preview-grid">
        <div class="preview-item" *ngFor="let url of uploadedMediaUrls; let i = index">
          <img *ngIf="uploadedMediaTypes[i] === 'image'"
               [src]="getMediaUrl(url)"
               alt="Uploaded"
               class="preview-image clickable"
               (click)="openPreview(getMediaUrl(url), 'image', i, true)"
               title="Click to enlarge">
          <div *ngIf="uploadedMediaTypes[i] === 'video'" class="video-preview-wrapper"
               (click)="openPreview(getMediaUrl(url), 'video', i, true)" title="Click to enlarge">
            <video [src]="getMediaUrl(url)" class="preview-video" muted></video>
            <div class="play-overlay"><mat-icon>play_circle</mat-icon></div>
          </div>
          <div class="enlarge-hint"><mat-icon>zoom_in</mat-icon></div>
          <button mat-icon-button type="button" (click)="removeMedia(i, true); $event.stopPropagation()" class="remove-btn">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- Selected Files Preview -->
    <div class="media-gallery" *ngIf="mediaPreviews.length > 0">
      <h4>New Media (Not Yet Uploaded)</h4>
      <div class="preview-grid">
        <div class="preview-item pending" *ngFor="let preview of mediaPreviews; let i = index">
          <img *ngIf="mediaTypes[i] === 'image'"
               [src]="preview"
               alt="Preview"
               class="preview-image clickable"
               (click)="openPreview(preview, 'image', i, false)"
               title="Click to enlarge">
          <div *ngIf="mediaTypes[i] === 'video'" class="video-preview-wrapper"
               (click)="openPreview(preview, 'video', i, false)" title="Click to enlarge">
            <video [src]="preview" class="preview-video" muted></video>
            <div class="play-overlay"><mat-icon>play_circle</mat-icon></div>
          </div>
          <div class="enlarge-hint"><mat-icon>zoom_in</mat-icon></div>
          <button mat-icon-button type="button" (click)="removeMedia(i, false); $event.stopPropagation()" class="remove-btn">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>
      <small class="upload-hint">Click on media to preview. New media will be uploaded when you save.</small>
    </div>

    <!-- Clear All Button -->
    <button mat-button type="button" (click)="clearAllMedia()" *ngIf="getTotalMediaCount() > 0" class="clear-all-btn">
      <mat-icon>clear_all</mat-icon>
      Clear All Media
    </button>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()" [disabled]="isLoading || isUploading">Cancel</button>
  <button mat-raised-button color="primary" (click)="onSubmit()"
          [disabled]="isLoading || isUploading || postForm.invalid">
    <mat-spinner diameter="20" *ngIf="isLoading || isUploading"></mat-spinner>
    <span *ngIf="!isLoading && !isUploading">Save Changes</span>
    <span *ngIf="isUploading">Uploading Media...</span>
    <span *ngIf="isLoading && !isUploading">Saving...</span>
  </button>
</mat-dialog-actions>

<!-- Lightbox Preview Overlay -->
<div class="lightbox-backdrop" *ngIf="previewOpen && previewUrl" (click)="onPreviewBackdropClick($event)">
  <div class="lightbox-container">
    <!-- Close button -->
    <button mat-icon-button class="lightbox-close" (click)="closePreview()">
      <mat-icon>close</mat-icon>
    </button>

    <!-- Content -->
    <div class="lightbox-content" (click)="$event.stopPropagation()">
      <!-- Image -->
      <img *ngIf="previewType === 'image'"
           [src]="previewUrl"
           alt="Preview"
           class="lightbox-image">

      <!-- Video -->
      <video *ngIf="previewType === 'video'"
             [src]="previewUrl"
             controls
             autoplay
             class="lightbox-video"></video>
    </div>

    <!-- Info bar -->
    <div class="lightbox-info">
      <span class="status-badge" [class.uploaded]="previewIsUploaded" [class.pending]="!previewIsUploaded">
        {{ previewIsUploaded ? 'Uploaded' : 'Pending Upload' }}
      </span>
    </div>
  </div>
</div>
